@page
@model EShope.Pages.Customer.IndexModel
@{
    ViewData["Title"] = "Customers";
    Layout = "_Layout";
    // اگر از query string برای search استفاده کردی:
    // var searchTerm = .Request.Query["searchTerm"].ToString();
}

@* پیام موفقیت (TempData) *@
@if (TempData["SuccessMessage"] is string successMsg && !string.IsNullOrWhiteSpace(successMsg))
{
    <div class="alert alert-success">
        @successMsg
    </div>
}

@* نمایش پیام های خطا/هشدار از ModelState *@
@if (!ViewData.ModelState.IsValid)
{
    <div class="alert alert-danger">
        <ul class="mb-0">
            @foreach (var entry in ViewData.ModelState)
            {
                foreach (var err in entry.Value.Errors)
                {
                    <li>@err.ErrorMessage</li>
                }
            }
        </ul>
    </div>
}

<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12 d-flex justify-content-between align-items-center">
            <h1 class="display-6">Customer Directory</h1>

            <div>
                <!-- فرم جستجو: با Razor Pages از asp-page استفاده کنید -->
                <form method="get" asp-page="./Index" class="d-flex gap-2 align-items-center" style="height: 48px;">
                    <div class="input-group" style="max-width: 280px;  height: 100%;">
                        <input type="text" name="searchTerm" class="form-control h-100"
                               value="@(Model.SearchTerm ?? string.Empty)" placeholder="Search by National Code" />
                        <button type="submit" class="btn btn-primary h-100">
                            <i class="bi bi-search"></i>
                        </button>
                    </div>
                    <a asp-page="/Customer/CreateModel" 
                        class="btn btn-success d-flex align-items-center justify-content-center px-3 h-100" style="white-space: nowrap;">
                        <i class="bi bi-person-plus"></i>
                    </a>
                </form>
            </div>
        </div>
    </div>

    <div class="table-responsive  shadow-sm" style="border-radius: 10px; overflow: hidden;">
        <table class="table table-striped table-hover align-middle mb-0">
            <thead class="table-dark">
                <tr>
                    <th></th>
                    <th>Name</th>
                    <th>Family</th>
                    <th>Birth Date</th>
                    <th>National Code</th>
                    <th>City</th>
                    <th class="text-center">Actions</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Customers?.Any() != true)
                {
                    <tr>
                        <td colspan="6" class="text-center">No customers found.</td>
                    </tr>
                }
                else
                {
                    foreach (var item in Model.Customers)
                    {
                        <tr>
                            <td> </td>
                            <td>@item.Name</td>
                            <td>@item.Family</td>
                            <td>@(item.Birth?.ToString("yyyy-MM-dd") ?? "")</td>
                            <td>@item.NationalCode</td>
                            <td>@(item.addressDto?.City ?? "----")</td>
                            <td class="text-center">
                                <div class="d-flex justify-content-center gap-2">
                                    <a class="btn btn-dark btn-circle" asp-page="/Customer/EditModel" asp-route-id="@item.Id" title="Edit">
                                        <i class="bi bi-pencil-square"></i>
                                    </a>

                                    <!-- details با AJAX به handler صفحه می‌زند -->
                                    <button type="button" class="btn btn-primary btn-circle btn-details" data-id="@item.Id" title="Details">
                                        <i class="bi bi-info-circle"></i>
                                    </button>

                                    <!-- حذف با فرم POST به handler صفحه -->
                                    <form method="post" asp-page-handler="Delete" asp-route-id="@item.Id" class="d-inline"
                                          onsubmit="return confirm('آیا از حذف این مشتری اطمینان دارید؟');">
                                        <button type="submit" class="btn btn-danger btn-circle" title="Delete">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        
    </div>

    <!-- Detail Modal -->
    <div class="modal fade" id="detailModal" tabindex="-1" aria-labelledby="detailModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content shadow-lg border-0" style="border-radius: 15px;">
                <div class="modal-header bg-primary text-white" style="border-top-left-radius: 15px; border-top-right-radius: 15px;">
                    <h5 class="modal-title d-flex align-items-center gap-2">
                        <i class="bi bi-person-vcard-fill"></i>
                        Customer Details
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>

                <div class="modal-body bg-light" id="modalDetailContent" style="border-radius: 0 0 15px 15px;">
                    <dl class="row mb-0">
                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-person"></i> Name
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-name"></dd>

                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-people"></i> Family
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-family"></dd>

                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-credit-card-2-front"></i> National Code
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-national"></dd>

                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-geo-alt"></i> City
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-city"></dd>

                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-map"></i> State
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-state"></dd>

                        <dt class="col-sm-4 fw-semibold text-secondary">
                            <i class="bi bi-telephone"></i> Telephone
                        </dt>
                        <dd class="col-sm-8 text-dark" id="d-tel"></dd>
                    </dl>
                </div>
            </div>
        </div>
    </div>
    @{
        var cur = Model.PageNumber <= 0 ? 1 : Model.PageNumber;
        var total = Model.TotalPages <= 0 ? 1 : Model.TotalPages;
        var startPage = Math.Max(1, cur - 1);
        var endPage = Math.Min(total, cur + 1);
        if (endPage - startPage < 2)
        {
            if (startPage == 1) endPage = Math.Min(total, startPage + 2);
            else if (endPage == total) startPage = Math.Max(1, endPage - 2);
        }
    }

    @if (Model.TotalRecords > 0)
    {
        <div class="d-flex justify-content-between align-items-center mt-3">
            <div>
                <small>نمایش @((Model.PageNumber - 1) * Model.PageSize + 1) - @(Math.Min(Model.PageNumber * Model.PageSize, Model.TotalRecords)) از @Model.TotalRecords</small>
            </div>

            <nav aria-label="Page navigation">
                <ul class="pagination mb-0">
                    <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-searchTerm="@(Model.SearchTerm)" asp-route-pageNumber="1" asp-route-pageSize="@(Model.PageSize)">اول</a>
                    </li>
                    <li class="page-item @(Model.PageNumber <= 1 ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-searchTerm="@(Model.SearchTerm)" asp-route-pageNumber="@(Math.Max(1, Model.PageNumber - 1))" asp-route-pageSize="@(Model.PageSize)">قبلی</a>
                    </li>

                    @for (int p = startPage; p <= endPage; p++)
                    {
                        <li class="page-item @(p == Model.PageNumber ? "active" : "")">
                            <a class="page-link" asp-page="./Index" asp-route-searchTerm="@(Model.SearchTerm)" asp-route-pageNumber="@p" asp-route-pageSize="@(Model.PageSize)">@p</a>
                        </li>
                    }

                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-searchTerm="@(Model.SearchTerm)" asp-route-pageNumber="@(Math.Min(Model.TotalPages, Model.PageNumber + 1))" asp-route-pageSize="@(Model.PageSize)">بعدی</a>
                    </li>
                    <li class="page-item @(Model.PageNumber >= Model.TotalPages ? "disabled" : "")">
                        <a class="page-link" asp-page="./Index" asp-route-searchTerm="@(Model.SearchTerm)" asp-route-pageNumber="@(Model.TotalPages)" asp-route-pageSize="@(Model.PageSize)">آخر</a>
                    </li>
                </ul>
            </nav>
        </div>
    }

</div>

<style>
    .btn-circle {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        padding: 0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .table td {
        vertical-align: middle;
    }
</style>

@section Scripts {
    <script>
        (function () {
            const detailsHandlerBase = '@Url.Page("./Index", null, new { handler = "Details" }, protocol: null)';

            document.querySelectorAll('.btn-details').forEach(btn => {
                btn.addEventListener('click', async function () {
                    const id = this.getAttribute('data-id');
                    if (!id) return;

                    const url = detailsHandlerBase + (detailsHandlerBase.includes('?') ? '&' : '?') + 'id=' + encodeURIComponent(id);

                    try {
                        const res = await fetch(url, { credentials: 'same-origin' });
                        if (!res.ok) {
                            alert('خطا در دریافت جزئیات مشتری');
                            return;
                        }
                        const data = await res.json();

                        // لاگ برای دیباگ
                        console.log('Received data:', data);

                        // استفاده از ساختار PascalCase (C# default)
                        document.getElementById('d-name').textContent = data?.Name || data?.name || '----';
                        document.getElementById('d-family').textContent = data?.Family || data?.family || '----';
                        document.getElementById('d-national').textContent = data?.NationalCode || data?.nationalCode || '----';

                        // بررسی ساختار آدرس - همه حالت‌های ممکن را چک کنید
                        const address = data?.addressDto || data?.address;
                        if (address) {
                            console.log('Address data:', address);
                            document.getElementById('d-city').textContent = address.City || address.city || '----';
                            document.getElementById('d-state').textContent = address.State || address.state || '----';
                            document.getElementById('d-tel').textContent = address.Tellphone || address.tellphone || '----';
                        } else {
                            console.warn('No address data found');
                            document.getElementById('d-city').textContent = '----';
                            document.getElementById('d-state').textContent = '----';
                            document.getElementById('d-tel').textContent = '----';
                        }

                        var myModal = new bootstrap.Modal(document.getElementById('detailModal'));
                        myModal.show();
                    } catch (err) {
                        console.error('Error:', err);
                        alert('خطا در ارتباط با سرور');
                    }
                });
            });
        })();
    </script>
}
